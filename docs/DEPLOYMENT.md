# Deployment Guide

## Overview

Todoist is a Next.js 16 application backed by PostgreSQL via Prisma Postgres. For local development, it uses the `prisma dev` command to run a local Prisma Postgres server (which includes a local PostgreSQL instance). For production deployment, it targets Vercel (or any Node.js hosting platform) with a remote PostgreSQL database.

## Environment Variables

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `DATABASE_URL` | Prisma Postgres connection string | Yes | `prisma+postgres://localhost:51213/?api_key=...` |

### DATABASE_URL Format

The `DATABASE_URL` uses the Prisma Postgres protocol (`prisma+postgres://`), which wraps a standard PostgreSQL connection string with Prisma's connection pooling layer.

**Local development** (generated by `prisma dev`):
```
prisma+postgres://localhost:51213/?api_key=<base64-encoded-config>
```

**Production** (Prisma Postgres cloud or direct PostgreSQL):
```
prisma+postgres://<host>:<port>/?api_key=<api-key>
```

The API key in the local development URL is a Base64-encoded JSON object containing the actual PostgreSQL connection string, shadow database URL, and connection pool settings. It does not contain sensitive credentials in local mode.

## Local Development

### Prerequisites

- Node.js 20+
- npm

### Setup

```bash
# 1. Clone the repository
git clone <repository-url>
cd todoist

# 2. Install dependencies
npm install

# 3. Start the local Prisma Postgres server
#    This starts a local PostgreSQL instance and generates DATABASE_URL
npx prisma dev

# 4. In a separate terminal, generate the Prisma client
npm run db:generate

# 5. Run database migrations
npm run db:migrate

# 6. Start the Next.js development server
npm run dev
```

The app will be available at `http://localhost:3000`.

### Available Scripts

| Script | Command | Description |
|--------|---------|-------------|
| `npm run dev` | `next dev` | Start development server with hot reload |
| `npm run build` | `next build` | Build production bundle |
| `npm start` | `next start` | Start production server |
| `npm run lint` | `biome check` | Run Biome linter and formatter checks |
| `npm run format` | `biome format --write` | Auto-format code with Biome |
| `npm test` | `vitest run` | Run all tests once |
| `npm run db:generate` | `prisma generate` | Generate Prisma client from schema |
| `npm run db:migrate` | `prisma migrate dev` | Create and apply database migrations |
| `npm run db:push` | `prisma db push` | Push schema changes directly (no migration file) |
| `npm run db:studio` | `prisma studio` | Open Prisma Studio database GUI |

### Development Database

The `prisma dev` command manages a local PostgreSQL instance:

- **Database server:** Runs on port 51214 (default)
- **Prisma Postgres proxy:** Runs on port 51213 (default)
- **Shadow database:** Runs on port 51215 (used for migration diffing)
- **Data location:** Managed by Prisma CLI in a local directory

To reset the database:
```bash
npx prisma migrate reset
```

## Production Build

```bash
# Build the Next.js production bundle
npm run build

# Start the production server
npm start
```

The build process:
1. Compiles TypeScript
2. Builds Next.js optimized production bundle
3. Generates static pages where possible
4. Server components are rendered at request time

## Cloud Deployment

### Vercel (Recommended)

```
┌──────────────┐     ┌───────────────────┐     ┌──────────────┐
│   Browser     │────>│   Vercel Edge     │────>│  PostgreSQL   │
│               │<────│   (Next.js SSR)   │<────│  (Prisma      │
│               │     │                   │     │   Postgres)   │
└──────────────┘     └───────────────────┘     └──────────────┘
```

1. Connect the Git repository to Vercel
2. Set the `DATABASE_URL` environment variable to your production Prisma Postgres or PostgreSQL connection string
3. Vercel auto-detects Next.js and configures the build:
   - Build command: `next build`
   - Output directory: `.next`
4. On each push, Vercel builds and deploys automatically

**Database options for production:**
- **Prisma Postgres** (managed): Use the connection string from Prisma Console
- **Vercel Postgres**: Use `@vercel/postgres` adapter
- **External PostgreSQL** (e.g., Supabase, Neon, Railway): Use the direct connection string

### Pre-deployment Checklist

- [ ] All tests pass: `npm test`
- [ ] Lint is clean: `npm run lint`
- [ ] Build succeeds: `npm run build`
- [ ] `DATABASE_URL` is set in the deployment environment
- [ ] Database migrations are applied: `npx prisma migrate deploy`
- [ ] `.env` file is NOT committed (listed in `.gitignore`)

## Rollback

### Application Rollback

**Vercel:**
- Navigate to the Deployments tab in the Vercel dashboard
- Click "Promote to Production" on a previous deployment

**Manual:**
```bash
# Revert to a previous commit
git revert HEAD
git push origin main
```

### Database Rollback

Prisma does not support automatic migration rollback. For manual rollback:

```bash
# View migration history
npx prisma migrate status

# To undo the last migration, create a new migration that reverses changes
npx prisma migrate dev --name rollback_description
```

For emergency rollback, restore from a database backup or use your hosting provider's point-in-time recovery.

## Troubleshooting

| Issue | Cause | Resolution |
|-------|-------|------------|
| `prisma dev` fails to start | Port conflict on 51213-51215 | Kill any existing Prisma dev processes: `lsof -i :51213` then `kill <PID>` |
| "Too many Prisma clients" in dev | Hot module reload creating new clients | Verify `src/lib/db.ts` uses the singleton pattern (attaches to `globalThis`) |
| Prisma generate fails | Missing or invalid schema | Run `npx prisma validate` to check schema; ensure `prisma/schema.prisma` exists |
| Database connection refused | Prisma Postgres server not running | Start it with `npx prisma dev` in a separate terminal |
| Build fails with type errors | Generated Prisma client out of date | Run `npm run db:generate` to regenerate, then `npm run build` |
| Migration drift | Schema and database are out of sync | Run `npx prisma migrate dev` to create a new migration or `npx prisma db push` for dev |
| `.env` not loaded by Prisma | Prisma 6+ requires explicit dotenv import | Verify `prisma.config.ts` includes `import "dotenv/config"` at the top |
| Port 3000 already in use | Another process on port 3000 | Use `npm run dev -- -p 3001` or kill the conflicting process |
| Cascade delete not working | Missing `onDelete: Cascade` in schema | Check `prisma/schema.prisma` relations; run `npx prisma migrate dev` after changes |
| Subtask creation blocked | Attempting to nest a subtask under another subtask | One-level nesting is enforced in `task.service.ts`; parent task must have `parentTaskId: null` |
